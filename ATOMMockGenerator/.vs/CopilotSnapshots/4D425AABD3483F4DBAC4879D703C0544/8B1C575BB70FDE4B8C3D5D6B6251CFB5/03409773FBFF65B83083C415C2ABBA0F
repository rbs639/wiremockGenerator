using Microsoft.AspNetCore.Mvc;
using ATOMMockGenerator.Server.Models;
using ATOMMockGenerator.Server.Services;
using System.Text.Json;

namespace ATOMMockGenerator.Server.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class ConfigController : ControllerBase
    {
        private readonly IConfigValidationService _validationService;
        private readonly IMappingService _mappingService;
        private readonly IWiremockAdminService _wiremockAdminService;

        public ConfigController(IConfigValidationService validationService, IMappingService mappingService, IWiremockAdminService wiremockAdminService)
        {
            _validationService = validationService;
            _mappingService = mappingService;
            _wiremockAdminService = wiremockAdminService;
        }

        [HttpPost("validate")]
        public IActionResult ValidateConfig([FromBody] JsonElement configJson)
        {
            try
            {
                // Debug logging
                Console.WriteLine($"Received JSON: {configJson.GetRawText()}");
                
                var result = _validationService.ValidateConfigFromJson(configJson);
                Console.WriteLine($"Validation result: IsValid={result.IsValid}, Errors={result.Errors.Count}");
                
                return Ok(result);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Validation exception: {ex.Message}");
                Console.WriteLine($"Stack trace: {ex.StackTrace}");
                
                return BadRequest(new ValidationResult
                {
                    IsValid = false,
                    Errors = new List<ValidationError> 
                    { 
                        new ValidationError { Path = "root", Message = $"Validation failed: {ex.Message}", Severity = "error" } 
                    }
                });
            }
        }

        [HttpPost("validate-and-deploy")]
        public async Task<IActionResult> ValidateAndDeployConfig([FromBody] JsonElement configJson)
        {
            try
            {
                // Debug logging
                Console.WriteLine($"Received JSON for validation and deployment: {configJson.GetRawText()}");
                
                // First validate the config
                var validationResult = _validationService.ValidateConfigFromJson(configJson);
                Console.WriteLine($"Validation result: IsValid={validationResult.IsValid}, Errors={validationResult.Errors.Count}");
                
                if (!validationResult.IsValid)
                {
                    return BadRequest(new
                    {
                        success = false,
                        message = "Configuration validation failed",
                        validation = validationResult
                    });
                }

                // Configure JsonSerializer options for camelCase naming
                var options = new JsonSerializerOptions
                {
                    PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
                    PropertyNameCaseInsensitive = true
                };

                // Determine config type and generate mappings
                var isAtomConfig = configJson.TryGetProperty("mocks", out var mocksProperty) && mocksProperty.ValueKind == JsonValueKind.Array;
                
                List<WiremockMapping> mappings;
                string targetBaseUrl;
                AuthConfig? authConfig = null;

                if (isAtomConfig)
                {
                    var atomConfig = JsonSerializer.Deserialize<ATOMConfig>(configJson.GetRawText(), options);
                    if (atomConfig == null)
                    {
                        return BadRequest(new { success = false, message = "Failed to deserialize ATOM config" });
                    }

                    // Extract target configuration
                    if (atomConfig.Target == null || string.IsNullOrWhiteSpace(atomConfig.Target.BaseUrl))
                    {
                        return BadRequest(new { success = false, message = "Target baseUrl is required for ATOM config" });
                    }

                    targetBaseUrl = atomConfig.Target.BaseUrl;
                    authConfig = atomConfig.Target.Auth;
                    
                    mappings = await _mappingService.GenerateMappingsFromATOMAsync(atomConfig);
                }
                else
                {
                    var legacyConfig = JsonSerializer.Deserialize<JsonConfig>(configJson.GetRawText(), options);
                    if (legacyConfig == null)
                    {
                        return BadRequest(new { success = false, message = "Failed to deserialize legacy config" });
                    }

                    // For legacy config, use baseUrl or default
                    targetBaseUrl = legacyConfig.BaseUrl ?? "http://localhost:8080";
                    
                    mappings = await _mappingService.GenerateMappingsAsync(legacyConfig);
                }

                Console.WriteLine($"Generated {mappings.Count} mappings, deploying to {targetBaseUrl}");

                // Deploy mappings to Wiremock
                var deployedMappings = await _wiremockAdminService.CreateMappingsAsync(targetBaseUrl, mappings, authConfig);

                var response = new
                {
                    success = true,
                    message = $"Successfully validated and deployed {deployedMappings.Count} mappings to {targetBaseUrl}",
                    validation = validationResult,
                    deployed = new
                    {
                        target = targetBaseUrl,
                        mappingsCount = deployedMappings.Count,
                        mappings = deployedMappings.Select(m => new { id = m.Id, method = m.Request.Method, url = m.Request.Url ?? m.Request.UrlPattern })
                    }
                };

                return Ok(response);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Validation and deployment exception: {ex.Message}");
                Console.WriteLine($"Stack trace: {ex.StackTrace}");
                
                return StatusCode(500, new
                {
                    success = false,
                    message = $"Failed to validate and deploy config: {ex.Message}",
                    error = ex.Message
                });
            }
        }

        [HttpPost("deploy-mappings")]
        public async Task<IActionResult> DeployMappings([FromBody] DeployMappingsRequest request)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(request.TargetUrl))
                {
                    return BadRequest(new { success = false, message = "Target URL is required" });
                }

                if (request.Mappings == null || !request.Mappings.Any())
                {
                    return BadRequest(new { success = false, message = "At least one mapping is required" });
                }

                Console.WriteLine($"Deploying {request.Mappings.Count} mappings to {request.TargetUrl}");

                // Deploy mappings to Wiremock
                var deployedMappings = await _wiremockAdminService.CreateMappingsAsync(request.TargetUrl, request.Mappings, request.Auth);

                var response = new
                {
                    success = true,
                    message = $"Successfully deployed {deployedMappings.Count} mappings to {request.TargetUrl}",
                    deployed = new
                    {
                        target = request.TargetUrl,
                        mappingsCount = deployedMappings.Count,
                        mappings = deployedMappings.Select(m => new { id = m.Id, method = m.Request.Method, url = m.Request.Url ?? m.Request.UrlPattern })
                    }
                };

                return Ok(response);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Deployment exception: {ex.Message}");
                
                return StatusCode(500, new
                {
                    success = false,
                    message = $"Failed to deploy mappings: {ex.Message}",
                    error = ex.Message
                });
            }
        }

        [HttpDelete("reset-wiremock")]
        public async Task<IActionResult> ResetWiremockMappings([FromBody] ResetWiremockRequest request)
        {
            try
            {
                if (string.IsNullOrWhiteSpace(request.TargetUrl))
                {
                    return BadRequest(new { success = false, message = "Target URL is required" });
                }

                Console.WriteLine($"Resetting all mappings on {request.TargetUrl}");

                await _wiremockAdminService.ResetMappingsAsync(request.TargetUrl, request.Auth);

                return Ok(new
                {
                    success = true,
                    message = $"Successfully reset all mappings on {request.TargetUrl}"
                });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Reset exception: {ex.Message}");
                
                return StatusCode(500, new
                {
                    success = false,
                    message = $"Failed to reset mappings: {ex.Message}",
                    error = ex.Message
                });
            }
        }

        [HttpGet("template")]
        public IActionResult GetTemplate()
        {
            // Return the ATOM config template
            var template = new ATOMConfig
            {
                Version = "1.0",
                Target = new TargetConfig
                {
                    BaseUrl = "http://localhost:8080",
                    Auth = new AuthConfig
                    {
                        Type = "basic",
                        Username = "admin",
                        Password = "admin123"
                    }
                },
                Defaults = new DefaultsConfig
                {
                    Priority = 5,
                    Headers = new Dictionary<string, string>
                    {
                        { "Content-Type", "application/json" }
                    },
                    Templating = new TemplatingConfig { Enabled = false }
                },
                Mocks = new List<MockConfig>
                {
                    new MockConfig
                    {
                        Name = "Get planned outages",
                        Priority = 1,
                        Request = new MockRequest
                        {
                            Method = "GET",
                            UrlPattern = "/webapi/OutageListData/GetDetailedPlannedOutages.*"
                        },
                        Response = new MockResponse
                        {
                            Status = 200,
                            Headers = new Dictionary<string, string>
                            {
                                { "Content-Type", "application/json" }
                            },
                            Body = new ResponseBody
                            {
                                Type = "inline",
                                Value = "[{\"Area\":\"Berry Park, Duckenfield, Millers Forest, Morpeth\",\"Cause\":\"Replacing or fixing powerlines above ground in your neighbourhood\",\"Detail\":\"\",\"Customers\":\"79\",\"EndDateTime\":\"2025-06-19T16:00:00\",\"StartDateTime\":\"2025-06-19T08:00:00\",\"Status\":\"Proceeding as scheduled\",\"Reason\":null,\"Streets\":\"Duckenfield Rd, Duckenfield Wharf Rd, Eales Rd, McFarlanes Rd, Raymond Terrace Rd, Wharf Rd\",\"WebId\":80450,\"JobId\":\"120938\"}]"
                            }
                        }
                    },
                    new MockConfig
                    {
                        Name = "Get user by id",
                        Priority = 2,
                        Request = new MockRequest
                        {
                            Method = "GET",
                            UrlPath = "/users/{userId}",
                            PathTemplate = "/users/{userId}",
                            QueryParameters = new Dictionary<string, RequestMatcher>
                            {
                                { "verbose", new RequestMatcher { EqualTo = "true" } }
                            },
                            Headers = new Dictionary<string, RequestMatcher>
                            {
                                { "Accept", new RequestMatcher { Contains = "application/json" } }
                            }
                        },
                        Response = new MockResponse
                        {
                            Status = 200,
                            Headers = new Dictionary<string, string>
                            {
                                { "Content-Type", "application/json" }
                            },
                            Body = new ResponseBody
                            {
                                Type = "inline",
                                Value = "{ \"id\": \"{{request.pathSegments.[1]}}\", \"name\": \"John\" }",
                                Templating = true
                            },
                            FixedDelayMilliseconds = 100
                        },
                        Scenario = new ScenarioConfig
                        {
                            Name = "User lifecycle",
                            RequiredState = "Started",
                            NewState = "Fetched"
                        },
                        Metadata = new Dictionary<string, object>
                        {
                            { "owner", "team-a" },
                            { "jira", "ABC-123" }
                        }
                    },
                    new MockConfig
                    {
                        Name = "Create user",
                        Priority = 3,
                        Request = new MockRequest
                        {
                            Method = "POST",
                            UrlPath = "/users",
                            BodyPatterns = new List<RequestBodyPattern>
                            {
                                new RequestBodyPattern
                                {
                                    EqualToJson = new EqualToJsonPattern
                                    {
                                        Json = "{ \"role\": \"basic\" }",
                                        IgnoreExtraElements = true
                                    }
                                }
                            }
                        },
                        Response = new MockResponse
                        {
                            Status = 201,
                            Headers = new Dictionary<string, string>
                            {
                                { "Location", "/users/1001" }
                            },
                            Body = new ResponseBody
                            {
                                Type = "file",
                                FileName = "users/create-success.json"
                            }
                        }
                    }
                }
            };

            var json = JsonSerializer.Serialize(template, new JsonSerializerOptions
            {
                WriteIndented = true,
                PropertyNamingPolicy = JsonNamingPolicy.CamelCase
            });

            return File(System.Text.Encoding.UTF8.GetBytes(json), "application/json", "atom-config-template.json");
        }

        [HttpGet("template-legacy")]
        public IActionResult GetLegacyTemplate()
        {
            var template = new JsonConfig
            {
                Name = "Sample Wiremock Configuration",
                Version = "1.0.0",
                BaseUrl = "http://localhost:8080",
                Port = 8080,
                Mappings = new List<WiremockMapping>
                {
                    new WiremockMapping
                    {
                        Request = new WiremockRequest
                        {
                            Method = "GET",
                            Url = "/api/users"
                        },
                        Response = new WiremockResponse
                        {
                            Status = 200,
                            Headers = new Dictionary<string, string>
                            {
                                { "Content-Type", "application/json" }
                            },
                            Body = "[{\"id\": 1, \"name\": \"John Doe\", \"email\": \"john@example.com\"}]"
                        },
                        Priority = 1
                    },
                    new WiremockMapping
                    {
                        Request = new WiremockRequest
                        {
                            Method = "GET",
                            UrlPattern = "/api/users/([0-9]+)"
                        },
                        Response = new WiremockResponse
                        {
                            Status = 200,
                            Headers = new Dictionary<string, string>
                            {
                                { "Content-Type", "application/json" }
                            },
                            Body = "{\"id\": 1, \"name\": \"John Doe\", \"email\": \"john@example.com\"}"
                        },
                        Priority = 2
                    },
                    new WiremockMapping
                    {
                        Request = new WiremockRequest
                        {
                            Method = "POST",
                            Url = "/api/users"
                        },
                        Response = new WiremockResponse
                        {
                            Status = 201,
                            Headers = new Dictionary<string, string>
                            {
                                { "Content-Type", "application/json" },
                                { "Location", "/api/users/2" }
                            },
                            Body = "{\"id\": 2, \"name\": \"New User\", \"email\": \"newuser@example.com\"}"
                        },
                        Priority = 1
                    }
                }
            };

            var json = JsonSerializer.Serialize(template, new JsonSerializerOptions
            {
                WriteIndented = true
            });

            return File(System.Text.Encoding.UTF8.GetBytes(json), "application/json", "wiremock-config-template.json");
        }
    }
}