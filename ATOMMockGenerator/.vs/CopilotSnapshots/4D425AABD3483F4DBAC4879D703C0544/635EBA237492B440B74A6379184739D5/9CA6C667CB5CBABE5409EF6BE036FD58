import React, { useState, useEffect } from 'react';
import { FontAwesomeIcon } from '@fortawesome/react-fontawesome';
import { 
  faSearch, 
  faTrash, 
  faEdit, 
  faDownload,
  faCheckSquare,
  faSquare,
  faSpinner,
  faFilter,
  faSortAlphaDown,
  faSortAlphaUp
} from '@fortawesome/free-solid-svg-icons';
import type { WiremockMapping, User } from '../../types';
import { mappingService } from '../../services/api';
import { downloadFile, truncateText } from '../../utils/helpers';
import MappingEditor from './MappingEditor';

interface MappingListProps {
  currentUser?: User;
}

const MappingList: React.FC<MappingListProps> = ({ currentUser }) => {
  const [mappings, setMappings] = useState<WiremockMapping[]>([]);
  const [filteredMappings, setFilteredMappings] = useState<WiremockMapping[]>([]);
  const [selectedMappings, setSelectedMappings] = useState<Set<string>>(new Set());
  const [searchTerm, setSearchTerm] = useState('');
  const [sortField, setSortField] = useState<'url' | 'method' | 'status'>('url');
  const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('asc');
  const [filterMethod, setFilterMethod] = useState<string>('all');
  const [filterStatus, setFilterStatus] = useState<string>('all');
  const [isLoading, setIsLoading] = useState(true);
  const [editingMapping, setEditingMapping] = useState<WiremockMapping | null>(null);
  const [showEditor, setShowEditor] = useState(false);

  useEffect(() => {
    loadMappings();
  }, []);

  useEffect(() => {
    filterAndSortMappings();
  }, [mappings, searchTerm, sortField, sortDirection, filterMethod, filterStatus]);

  const loadMappings = async () => {
    try {
      setIsLoading(true);
      const data = await mappingService.getAllMappings();
      setMappings(data);
    } catch (error) {
      console.error('Failed to load mappings:', error);
      alert('Failed to load mappings');
    } finally {
      setIsLoading(false);
    }
  };

  const filterAndSortMappings = () => {
    let filtered = mappings.filter(mapping => {
      const url = mapping.request.url || mapping.request.urlPattern || '';
      const matchesSearch = url.toLowerCase().includes(searchTerm.toLowerCase()) ||
                           mapping.request.method.toLowerCase().includes(searchTerm.toLowerCase());
      
      const matchesMethod = filterMethod === 'all' || mapping.request.method === filterMethod;
      const matchesStatus = filterStatus === 'all' || mapping.response.status.toString() === filterStatus;
      
      return matchesSearch && matchesMethod && matchesStatus;
    });

    // Sort mappings
    filtered.sort((a, b) => {
      let aValue: string | number;
      let bValue: string | number;

      switch (sortField) {
        case 'url':
          aValue = a.request.url || a.request.urlPattern || '';
          bValue = b.request.url || b.request.urlPattern || '';
          break;
        case 'method':
          aValue = a.request.method;
          bValue = b.request.method;
          break;
        case 'status':
          aValue = a.response.status;
          bValue = b.response.status;
          break;
        default:
          return 0;
      }

      if (typeof aValue === 'string' && typeof bValue === 'string') {
        const result = aValue.localeCompare(bValue);
        return sortDirection === 'asc' ? result : -result;
      } else {
        const result = aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
        return sortDirection === 'asc' ? result : -result;
      }
    });

    setFilteredMappings(filtered);
  };

  const handleSort = (field: 'url' | 'method' | 'status') => {
    if (sortField === field) {
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      setSortField(field);
      setSortDirection('asc');
    }
  };

  const toggleMappingSelection = (id: string) => {
    const newSelection = new Set(selectedMappings);
    if (newSelection.has(id)) {
      newSelection.delete(id);
    } else {
      newSelection.add(id);
    }
    setSelectedMappings(newSelection);
  };

  const toggleSelectAll = () => {
    if (selectedMappings.size === filteredMappings.length) {
      setSelectedMappings(new Set());
    } else {
      setSelectedMappings(new Set(filteredMappings.map(m => m.id)));
    }
  };

  const handleDeleteSelected = async () => {
    if (selectedMappings.size === 0) return;
    
    if (!confirm(`Are you sure you want to delete ${selectedMappings.size} mapping(s)?`)) {
      return;
    }

    try {
      await Promise.all(Array.from(selectedMappings).map(id => 
        mappingService.deleteMapping(id)
      ));
      await loadMappings();
      setSelectedMappings(new Set());
    } catch (error) {
      console.error('Failed to delete mappings:', error);
      alert('Failed to delete mappings');
    }
  };

  const handleDownloadSelected = async () => {
    if (selectedMappings.size === 0) return;

    try {
      const blob = await mappingService.downloadMappings(Array.from(selectedMappings));
      downloadFile(blob, 'wiremock-mappings.zip');
    } catch (error) {
      console.error('Failed to download mappings:', error);
      alert('Failed to download mappings');
    }
  };

  const handleEditMapping = (mapping: WiremockMapping) => {
    setEditingMapping(mapping);
    setShowEditor(true);
  };

  const handleSaveMapping = async (mapping: WiremockMapping) => {
    try {
      await mappingService.updateMapping(mapping.id, mapping);
      await loadMappings();
      setShowEditor(false);
      setEditingMapping(null);
    } catch (error) {
      console.error('Failed to save mapping:', error);
      alert('Failed to save mapping');
    }
  };

  const canEdit = currentUser?.role === 'Admin' || currentUser?.role === 'Write';
  const canDelete = currentUser?.role === 'Admin';

  const uniqueMethods = Array.from(new Set(mappings.map(m => m.request.method)));
  const uniqueStatuses = Array.from(new Set(mappings.map(m => m.response.status.toString())));

  if (isLoading) {
    return (
      <div className="flex items-center justify-center py-12">
        <FontAwesomeIcon icon={faSpinner} className="animate-spin h-8 w-8 text-blue-600" />
        <span className="ml-3 text-lg text-gray-600">Loading mappings...</span>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header with Search and Actions */}
      <div className="card">
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div className="flex-1 max-w-md">
            <div className="relative">
              <FontAwesomeIcon 
                icon={faSearch} 
                className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
              />
              <input
                type="text"
                placeholder="Search mappings..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
          </div>

          <div className="flex items-center gap-3">
            {selectedMappings.size > 0 && (
              <>
                <button
                  onClick={handleDownloadSelected}
                  className="btn-secondary"
                >
                  <FontAwesomeIcon icon={faDownload} className="mr-2" />
                  Download ({selectedMappings.size})
                </button>
                {canDelete && (
                  <button
                    onClick={handleDeleteSelected}
                    className="btn-danger"
                  >
                    <FontAwesomeIcon icon={faTrash} className="mr-2" />
                    Delete ({selectedMappings.size})
                  </button>
                )}
              </>
            )}
          </div>
        </div>

        {/* Filters */}
        <div className="flex flex-wrap gap-4 mt-4 pt-4 border-t border-gray-200">
          <div className="flex items-center gap-2">
            <FontAwesomeIcon icon={faFilter} className="text-gray-500" />
            <select
              value={filterMethod}
              onChange={(e) => setFilterMethod(e.target.value)}
              className="border border-gray-300 rounded px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">All Methods</option>
              {uniqueMethods.map(method => (
                <option key={method} value={method}>{method}</option>
              ))}
            </select>
          </div>

          <div>
            <select
              value={filterStatus}
              onChange={(e) => setFilterStatus(e.target.value)}
              className="border border-gray-300 rounded px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">All Status Codes</option>
              {uniqueStatuses.map(status => (
                <option key={status} value={status}>{status}</option>
              ))}
            </select>
          </div>
        </div>
      </div>

      {/* Mappings Table */}
      <div className="card">
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left">
                  <button
                    onClick={toggleSelectAll}
                    className="text-gray-400 hover:text-gray-600"
                  >
                    <FontAwesomeIcon 
                      icon={selectedMappings.size === filteredMappings.length && filteredMappings.length > 0 ? faCheckSquare : faSquare} 
                    />
                  </button>
                </th>
                
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  <button
                    onClick={() => handleSort('method')}
                    className="flex items-center gap-1 hover:text-gray-700"
                  >
                    Method
                    {sortField === 'method' && (
                      <FontAwesomeIcon 
                        icon={sortDirection === 'asc' ? faSortAlphaDown : faSortAlphaUp}
                        className="text-xs"
                      />
                    )}
                  </button>
                </th>
                
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  <button
                    onClick={() => handleSort('url')}
                    className="flex items-center gap-1 hover:text-gray-700"
                  >
                    URL/Pattern
                    {sortField === 'url' && (
                      <FontAwesomeIcon 
                        icon={sortDirection === 'asc' ? faSortAlphaDown : faSortAlphaUp}
                        className="text-xs"
                      />
                    )}
                  </button>
                </th>
                
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  <button
                    onClick={() => handleSort('status')}
                    className="flex items-center gap-1 hover:text-gray-700"
                  >
                    Status
                    {sortField === 'status' && (
                      <FontAwesomeIcon 
                        icon={sortDirection === 'asc' ? faSortAlphaDown : faSortAlphaUp}
                        className="text-xs"
                      />
                    )}
                  </button>
                </th>
                
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Response
                </th>
                
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Actions
                </th>
              </tr>
            </thead>
            
            <tbody className="bg-white divide-y divide-gray-200">
              {filteredMappings.map((mapping) => (
                <tr key={mapping.id} className="hover:bg-gray-50">
                  <td className="px-6 py-4 whitespace-nowrap">
                    <button
                      onClick={() => toggleMappingSelection(mapping.id)}
                      className="text-gray-400 hover:text-gray-600"
                    >
                      <FontAwesomeIcon 
                        icon={selectedMappings.has(mapping.id) ? faCheckSquare : faSquare} 
                      />
                    </button>
                  </td>
                  
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                      mapping.request.method === 'GET' ? 'bg-green-100 text-green-800' :
                      mapping.request.method === 'POST' ? 'bg-blue-100 text-blue-800' :
                      mapping.request.method === 'PUT' ? 'bg-yellow-100 text-yellow-800' :
                      mapping.request.method === 'DELETE' ? 'bg-red-100 text-red-800' :
                      'bg-gray-100 text-gray-800'
                    }`}>
                      {mapping.request.method}
                    </span>
                  </td>
                  
                  <td className="px-6 py-4">
                    <div className="text-sm text-gray-900 font-mono">
                      {truncateText(mapping.request.url || mapping.request.urlPattern || '', 50)}
                    </div>
                  </td>
                  
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                      mapping.response.status >= 200 && mapping.response.status < 300 ? 'bg-green-100 text-green-800' :
                      mapping.response.status >= 300 && mapping.response.status < 400 ? 'bg-yellow-100 text-yellow-800' :
                      mapping.response.status >= 400 ? 'bg-red-100 text-red-800' :
                      'bg-gray-100 text-gray-800'
                    }`}>
                      {mapping.response.status}
                    </span>
                  </td>
                  
                  <td className="px-6 py-4">
                    <div className="text-sm text-gray-900">
                      {mapping.response.body ? (
                        <span className="text-gray-600">Body content</span>
                      ) : mapping.response.jsonBody ? (
                        <span className="text-gray-600">JSON response</span>
                      ) : mapping.response.bodyFileName ? (
                        <span className="text-gray-600">File: {mapping.response.bodyFileName}</span>
                      ) : (
                        <span className="text-gray-400">No response body</span>
                      )}
                    </div>
                  </td>
                  
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <div className="flex items-center gap-2">
                      {canEdit && (
                        <button
                          onClick={() => handleEditMapping(mapping)}
                          className="text-blue-600 hover:text-blue-900"
                        >
                          <FontAwesomeIcon icon={faEdit} />
                        </button>
                      )}
                      {canDelete && (
                        <button
                          onClick={() => {
                            if (confirm('Are you sure you want to delete this mapping?')) {
                              mappingService.deleteMapping(mapping.id).then(() => loadMappings());
                            }
                          }}
                          className="text-red-600 hover:text-red-900"
                        >
                          <FontAwesomeIcon icon={faTrash} />
                        </button>
                      )}
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>

          {filteredMappings.length === 0 && (
            <div className="text-center py-12">
              <p className="text-gray-500">No mappings found matching your criteria.</p>
            </div>
          )}
        </div>
      </div>

      {/* Mapping Editor Modal */}
      {showEditor && editingMapping && (
        <MappingEditor
          mapping={editingMapping}
          onSave={handleSaveMapping}
          onCancel={() => {
            setShowEditor(false);
            setEditingMapping(null);
          }}
        />
      )}
    </div>
  );
};

export default MappingList;