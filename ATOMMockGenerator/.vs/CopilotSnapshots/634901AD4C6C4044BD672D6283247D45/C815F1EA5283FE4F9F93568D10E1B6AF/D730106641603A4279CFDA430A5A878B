using Microsoft.AspNetCore.Mvc;
using ATOMMockGenerator.Server.Models;
using ATOMMockGenerator.Server.Services;
using System.Text.Json;

namespace ATOMMockGenerator.Server.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class ConfigController : ControllerBase
    {
        private readonly IConfigValidationService _validationService;
        private readonly IMappingService _mappingService;

        public ConfigController(IConfigValidationService validationService, IMappingService mappingService)
        {
            _validationService = validationService;
            _mappingService = mappingService;
        }

        [HttpPost("validate")]
        public IActionResult ValidateConfig([FromBody] JsonElement configJson)
        {
            try
            {
                // Debug logging
                Console.WriteLine($"Received JSON: {configJson.GetRawText()}");
                
                var result = _validationService.ValidateConfigFromJson(configJson);
                Console.WriteLine($"Validation result: IsValid={result.IsValid}, Errors={result.Errors.Count}");
                
                return Ok(result);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Validation exception: {ex.Message}");
                Console.WriteLine($"Stack trace: {ex.StackTrace}");
                
                return BadRequest(new ValidationResult
                {
                    IsValid = false,
                    Errors = new List<ValidationError> 
                    { 
                        new ValidationError { Path = "root", Message = $"Validation failed: {ex.Message}", Severity = "error" } 
                    }
                });
            }
        }

        [HttpPost("validate-legacy")]
        public IActionResult ValidateLegacyConfig([FromBody] JsonConfig config)
        {
            try
            {
                var result = _validationService.ValidateConfig(config);
                return Ok(result);
            }
            catch (Exception ex)
            {
                return BadRequest(new ValidationResult
                {
                    IsValid = false,
                    Errors = new List<ValidationError> 
                    { 
                        new ValidationError { Path = "root", Message = $"Validation failed: {ex.Message}", Severity = "error" } 
                    }
                });
            }
        }

        [HttpPost("validate-atom")]
        public IActionResult ValidateATOMConfig([FromBody] ATOMConfig config)
        {
            try
            {
                var result = _validationService.ValidateATOMConfig(config);
                return Ok(result);
            }
            catch (Exception ex)
            {
                return BadRequest(new ValidationResult
                {
                    IsValid = false,
                    Errors = new List<ValidationError> 
                    { 
                        new ValidationError { Path = "root", Message = $"Validation failed: {ex.Message}", Severity = "error" } 
                    }
                });
            }
        }

        [HttpPost("generate-mappings")]
        public async Task<IActionResult> GenerateMappings([FromBody] JsonElement configJson)
        {
            try
            {
                // First validate the config
                var validationResult = _validationService.ValidateConfigFromJson(configJson);
                if (!validationResult.IsValid)
                {
                    return BadRequest(validationResult);
                }

                // Determine config type and generate mappings
                var isAtomConfig = configJson.TryGetProperty("mocks", out var mocksProperty) && mocksProperty.ValueKind == JsonValueKind.Array;
                
                List<WiremockMapping> mappings;
                if (isAtomConfig)
                {
                    var atomConfig = JsonSerializer.Deserialize<ATOMConfig>(configJson.GetRawText());
                    if (atomConfig == null)
                    {
                        return BadRequest(new { error = "Failed to deserialize ATOM config" });
                    }
                    mappings = await _mappingService.GenerateMappingsFromATOMAsync(atomConfig);
                }
                else
                {
                    var legacyConfig = JsonSerializer.Deserialize<JsonConfig>(configJson.GetRawText());
                    if (legacyConfig == null)
                    {
                        return BadRequest(new { error = "Failed to deserialize legacy config" });
                    }
                    mappings = await _mappingService.GenerateMappingsAsync(legacyConfig);
                }

                return Ok(mappings);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { error = $"Failed to generate mappings: {ex.Message}" });
            }
        }

        [HttpGet("template")]
        public IActionResult GetTemplate()
        {
            // Return the ATOM config template
            var template = new ATOMConfig
            {
                Version = "1.0",
                Target = new TargetConfig
                {
                    BaseUrl = "http://wiremock.local:8080",
                    Auth = new AuthConfig
                    {
                        Type = "basic",
                        Username = "svc",
                        Password = "*****"
                    }
                },
                Defaults = new DefaultsConfig
                {
                    Priority = 5,
                    Headers = new Dictionary<string, string>
                    {
                        { "Content-Type", "application/json" }
                    },
                    Templating = new TemplatingConfig { Enabled = false }
                },
                Mocks = new List<MockConfig>
                {
                    new MockConfig
                    {
                        Name = "Get user by id",
                        Priority = 1,
                        Request = new MockRequest
                        {
                            Method = "GET",
                            UrlPath = "/users/{userId}",
                            PathTemplate = "/users/{userId}",
                            QueryParameters = new Dictionary<string, RequestMatcher>
                            {
                                { "verbose", new RequestMatcher { EqualTo = "true" } }
                            },
                            Headers = new Dictionary<string, RequestMatcher>
                            {
                                { "Accept", new RequestMatcher { Contains = "application/json" } }
                            }
                        },
                        Response = new MockResponse
                        {
                            Status = 200,
                            Headers = new Dictionary<string, string>
                            {
                                { "Content-Type", "application/json" }
                            },
                            Body = new ResponseBody
                            {
                                Type = "inline",
                                Value = "{ \"id\": \"{{request.pathSegments.[1]}}\", \"name\": \"John\" }",
                                Templating = true
                            },
                            FixedDelayMilliseconds = 100
                        },
                        Scenario = new ScenarioConfig
                        {
                            Name = "User lifecycle",
                            RequiredState = "Started",
                            NewState = "Fetched"
                        },
                        Metadata = new Dictionary<string, object>
                        {
                            { "owner", "team-a" },
                            { "jira", "ABC-123" }
                        }
                    },
                    new MockConfig
                    {
                        Name = "Create user",
                        Priority = 2,
                        Request = new MockRequest
                        {
                            Method = "POST",
                            UrlPath = "/users",
                            BodyPatterns = new List<RequestBodyPattern>
                            {
                                new RequestBodyPattern
                                {
                                    EqualToJson = new EqualToJsonPattern
                                    {
                                        Json = "{ \"role\": \"basic\" }",
                                        IgnoreExtraElements = true
                                    }
                                }
                            }
                        },
                        Response = new MockResponse
                        {
                            Status = 201,
                            Headers = new Dictionary<string, string>
                            {
                                { "Location", "/users/1001" }
                            },
                            Body = new ResponseBody
                            {
                                Type = "file",
                                FileName = "users/create-success.json"
                            }
                        }
                    }
                }
            };

            var json = JsonSerializer.Serialize(template, new JsonSerializerOptions
            {
                WriteIndented = true,
                PropertyNamingPolicy = JsonNamingPolicy.CamelCase
            });

            return File(System.Text.Encoding.UTF8.GetBytes(json), "application/json", "atom-config-template.json");
        }

        [HttpGet("template-legacy")]
        public IActionResult GetLegacyTemplate()
        {
            var template = new JsonConfig
            {
                Name = "Sample Wiremock Configuration",
                Version = "1.0.0",
                BaseUrl = "http://localhost:8080",
                Port = 8080,
                Mappings = new List<WiremockMapping>
                {
                    new WiremockMapping
                    {
                        Request = new WiremockRequest
                        {
                            Method = "GET",
                            Url = "/api/users"
                        },
                        Response = new WiremockResponse
                        {
                            Status = 200,
                            Headers = new Dictionary<string, string>
                            {
                                { "Content-Type", "application/json" }
                            },
                            Body = "[{\"id\": 1, \"name\": \"John Doe\", \"email\": \"john@example.com\"}]"
                        },
                        Priority = 1
                    },
                    new WiremockMapping
                    {
                        Request = new WiremockRequest
                        {
                            Method = "GET",
                            UrlPattern = "/api/users/([0-9]+)"
                        },
                        Response = new WiremockResponse
                        {
                            Status = 200,
                            Headers = new Dictionary<string, string>
                            {
                                { "Content-Type", "application/json" }
                            },
                            Body = "{\"id\": 1, \"name\": \"John Doe\", \"email\": \"john@example.com\"}"
                        },
                        Priority = 2
                    },
                    new WiremockMapping
                    {
                        Request = new WiremockRequest
                        {
                            Method = "POST",
                            Url = "/api/users"
                        },
                        Response = new WiremockResponse
                        {
                            Status = 201,
                            Headers = new Dictionary<string, string>
                            {
                                { "Content-Type", "application/json" },
                                { "Location", "/api/users/2" }
                            },
                            Body = "{\"id\": 2, \"name\": \"New User\", \"email\": \"newuser@example.com\"}"
                        },
                        Priority = 1
                    }
                }
            };

            var json = JsonSerializer.Serialize(template, new JsonSerializerOptions
            {
                WriteIndented = true
            });

            return File(System.Text.Encoding.UTF8.GetBytes(json), "application/json", "wiremock-config-template.json");
        }
    }
}