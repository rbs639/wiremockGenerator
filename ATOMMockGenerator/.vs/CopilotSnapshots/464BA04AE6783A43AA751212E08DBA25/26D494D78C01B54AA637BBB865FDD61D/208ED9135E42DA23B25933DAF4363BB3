using Microsoft.AspNetCore.Mvc;
using ATOMMockGenerator.Server.Models;
using ATOMMockGenerator.Server.Services;
using System.Text.Json;

namespace ATOMMockGenerator.Server.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class ConfigController : ControllerBase
    {
        private readonly IConfigValidationService _validationService;
        private readonly IMappingService _mappingService;

        public ConfigController(IConfigValidationService validationService, IMappingService mappingService)
        {
            _validationService = validationService;
            _mappingService = mappingService;
        }

        [HttpPost("validate")]
        public IActionResult ValidateConfig([FromBody] JsonConfig config)
        {
            try
            {
                var result = _validationService.ValidateConfig(config);
                return Ok(result);
            }
            catch (Exception ex)
            {
                return BadRequest(new ValidationResult
                {
                    IsValid = false,
                    Errors = new List<string> { $"Validation failed: {ex.Message}" }
                });
            }
        }

        [HttpPost("generate-mappings")]
        public async Task<IActionResult> GenerateMappings([FromBody] JsonConfig config)
        {
            try
            {
                // First validate the config
                var validationResult = _validationService.ValidateConfig(config);
                if (!validationResult.IsValid)
                {
                    return BadRequest(validationResult);
                }

                // Generate the mappings
                var mappings = await _mappingService.GenerateMappingsAsync(config);
                return Ok(mappings);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new { error = $"Failed to generate mappings: {ex.Message}" });
            }
        }

        [HttpGet("template")]
        public IActionResult GetTemplate()
        {
            var template = new JsonConfig
            {
                Name = "Sample Wiremock Configuration",
                Version = "1.0.0",
                BaseUrl = "http://localhost:8080",
                Port = 8080,
                Mappings = new List<WiremockMapping>
                {
                    new WiremockMapping
                    {
                        Request = new WiremockRequest
                        {
                            Method = "GET",
                            Url = "/api/users"
                        },
                        Response = new WiremockResponse
                        {
                            Status = 200,
                            Headers = new Dictionary<string, string>
                            {
                                { "Content-Type", "application/json" }
                            },
                            Body = "[{\"id\": 1, \"name\": \"John Doe\", \"email\": \"john@example.com\"}]"
                        },
                        Priority = 1
                    },
                    new WiremockMapping
                    {
                        Request = new WiremockRequest
                        {
                            Method = "GET",
                            UrlPattern = "/api/users/([0-9]+)"
                        },
                        Response = new WiremockResponse
                        {
                            Status = 200,
                            Headers = new Dictionary<string, string>
                            {
                                { "Content-Type", "application/json" }
                            },
                            Body = "{\"id\": 1, \"name\": \"John Doe\", \"email\": \"john@example.com\"}"
                        },
                        Priority = 2
                    },
                    new WiremockMapping
                    {
                        Request = new WiremockRequest
                        {
                            Method = "POST",
                            Url = "/api/users"
                        },
                        Response = new WiremockResponse
                        {
                            Status = 201,
                            Headers = new Dictionary<string, string>
                            {
                                { "Content-Type", "application/json" },
                                { "Location", "/api/users/2" }
                            },
                            Body = "{\"id\": 2, \"name\": \"New User\", \"email\": \"newuser@example.com\"}"
                        },
                        Priority = 1
                    }
                }
            };

            var json = JsonSerializer.Serialize(template, new JsonSerializerOptions
            {
                WriteIndented = true
            });

            return File(System.Text.Encoding.UTF8.GetBytes(json), "application/json", "wiremock-config-template.json");
        }
    }
}