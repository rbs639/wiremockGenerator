using ATOMMockGenerator.Server.Models;

namespace ATOMMockGenerator.Server.Services
{
    public interface IConfigValidationService
    {
        ValidationResult ValidateConfig(JsonConfig config);
    }

    public class ConfigValidationService : IConfigValidationService
    {
        public ValidationResult ValidateConfig(JsonConfig config)
        {
            var result = new ValidationResult();
            var errors = new List<string>();
            var warnings = new List<string>();

            // Basic validation
            if (string.IsNullOrWhiteSpace(config.Name))
            {
                errors.Add("Configuration name is required");
            }

            if (string.IsNullOrWhiteSpace(config.Version))
            {
                warnings.Add("Configuration version is recommended");
            }

            if (config.Mappings == null || config.Mappings.Count == 0)
            {
                errors.Add("At least one mapping is required");
            }
            else
            {
                for (int i = 0; i < config.Mappings.Count; i++)
                {
                    var mapping = config.Mappings[i];
                    var mappingPrefix = $"Mapping {i + 1}";

                    // Validate request
                    if (string.IsNullOrWhiteSpace(mapping.Request.Method))
                    {
                        errors.Add($"{mappingPrefix}: HTTP method is required");
                    }

                    if (string.IsNullOrWhiteSpace(mapping.Request.Url) && 
                        string.IsNullOrWhiteSpace(mapping.Request.UrlPattern))
                    {
                        errors.Add($"{mappingPrefix}: Either URL or URL pattern is required");
                    }

                    if (!string.IsNullOrWhiteSpace(mapping.Request.Url) && 
                        !string.IsNullOrWhiteSpace(mapping.Request.UrlPattern))
                    {
                        warnings.Add($"{mappingPrefix}: Both URL and URL pattern specified, URL pattern will take precedence");
                    }

                    // Validate response
                    if (mapping.Response.Status < 100 || mapping.Response.Status > 599)
                    {
                        errors.Add($"{mappingPrefix}: HTTP status code must be between 100 and 599");
                    }

                    // Check for conflicting response body types
                    var bodyCount = 0;
                    if (!string.IsNullOrWhiteSpace(mapping.Response.Body)) bodyCount++;
                    if (mapping.Response.JsonBody.HasValue) bodyCount++;
                    if (!string.IsNullOrWhiteSpace(mapping.Response.BodyFileName)) bodyCount++;

                    if (bodyCount > 1)
                    {
                        warnings.Add($"{mappingPrefix}: Multiple response body types specified, only one will be used");
                    }
                }
            }

            result.IsValid = errors.Count == 0;
            result.Errors = errors;
            result.Warnings = warnings;

            return result;
        }
    }
}